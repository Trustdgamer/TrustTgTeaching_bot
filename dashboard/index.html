<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrustBuddy Admin Dashboard</title>
<style>
  /* ===== Global ===== */
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    background: #0f1530;
    color: #fff;
  }
  header {
    background: linear-gradient(90deg,#b66cff,#ff6ec7);
    padding: 1rem;
    text-align: center;
    font-size: 1.8rem;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  }
  main {
    padding: 1rem;
    max-width: 1000px;
    margin: auto;
  }
  h2 {
    margin-top: 2rem;
    color: #00d4a9;
    font-size: 1.3rem;
    margin-bottom: 0.5rem;
  }
  .section {
    margin-bottom: 2rem;
    background: rgba(255,255,255,0.05);
    padding: 1rem;
    border-radius: 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
    font-size: 0.9rem;
  }
  th, td {
    padding: 0.6rem;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    text-align: left;
    word-break: break-word;
  }
  th { color: #b66cff; }
  button {
    background: #ff6ec7;
    border: none;
    padding: 0.5rem 0.9rem;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
    margin-top: 0.5rem;
    transition: all 0.2s;
  }
  button:hover {
    background: #b66cff;
  }
  input[type="number"], input[type="text"] {
    padding: 0.5rem;
    border-radius: 5px;
    border: none;
    margin-right: 0.5rem;
  }
  /* ===== Toast ===== */
  #toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 1rem;
    position: fixed;
    z-index: 999;
    left: 50%;
    bottom: 2rem;
    transform: translateX(-50%);
    font-size: 0.9rem;
  }
  #toast.show {
    visibility: visible;
    animation: fadein 0.5s, fadeout 0.5s 3s;
  }
  @keyframes fadein { from {bottom:0; opacity:0;} to {bottom:2rem; opacity:1;} }
  @keyframes fadeout { from {bottom:2rem; opacity:1;} to {bottom:0; opacity:0;} }
  /* ===== Responsive ===== */
  @media(max-width:600px){
    th, td { font-size: 0.8rem; }
    header { font-size: 1.4rem; }
    button, input { width: 100%; margin-bottom: 0.5rem; }
  }
</style>
</head>
<body>

<header>ü§ñ TrustBuddy Admin Dashboard</header>
<main>
  <div class="section">
    <h2>Users</h2>
    <table id="usersTable">
      <thead>
        <tr><th>ID</th><th>Name</th><th>Coins</th><th>VIP</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Leaderboard</h2>
    <table id="leaderboardTable">
      <thead><tr><th>Rank</th><th>ID</th><th>Points</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Active Battles</h2>
    <table id="battlesTable">
      <thead><tr><th>Code</th><th>Host</th><th>Status</th><th>Players</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Monetization: Give Coins</h2>
    <input type="text" id="giveUserId" placeholder="User ID">
    <input type="number" id="giveAmount" placeholder="Amount">
    <button onclick="giveCoins()">Give Coins</button>
  </div>
</main>

<div id="toast"></div>

<script>
const ADMIN_ID = "6499793556";

async function fetchUsers() {
  try {
    const res = await fetch(`/api/users?admin=${ADMIN_ID}`);
    const users = await res.json();
    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "";
    Object.values(users).forEach(u => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${u.id}</td><td>${u.username || u.first_name || 'Unknown'}</td><td>${u.coins || 0}</td><td>${u.vip ? "‚úÖ" : "‚ùå"}</td>`;
      tbody.appendChild(tr);
    });
  } catch(err) { showToast("‚ùå Failed to load users"); }
}

async function fetchLeaderboard() {
  try {
    const res = await fetch(`/api/leaderboard?admin=${ADMIN_ID}`);
    const lb = await res.json();
    const tbody = document.querySelector("#leaderboardTable tbody");
    tbody.innerHTML = "";
    const sorted = Object.entries(lb.scores)
      .sort((a,b)=>b[1]-a[1])
      .map(([id, pts], idx)=>({rank: idx+1,id,pts}));
    sorted.forEach(entry => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${entry.rank}</td><td>${entry.id}</td><td>${entry.pts}</td>`;
      tbody.appendChild(tr);
    });
  } catch(err){ showToast("‚ùå Failed to load leaderboard"); }
}

async function fetchBattles() {
  try {
    const res = await fetch(`/api/battles?admin=${ADMIN_ID}`);
    const battles = await res.json();
    const tbody = document.querySelector("#battlesTable tbody");
    tbody.innerHTML = "";
    battles.battles.forEach(b => {
      const tr = document.createElement("tr");
      const playersCount = Object.keys(b.players || {}).length;
      tr.innerHTML = `<td>${b.code}</td><td>${b.host}</td><td>${b.status}</td><td>${playersCount}</td>`;
      tbody.appendChild(tr);
    });
  } catch(err){ showToast("‚ùå Failed to load battles"); }
}

async function giveCoins() {
  const uid = document.getElementById("giveUserId").value;
  const amt = document.getElementById("giveAmount").value;
  if (!uid || !amt) return showToast("‚ö†Ô∏è Enter user ID and amount");

  try {
    const res = await fetch(`/api/give-coins?admin=${ADMIN_ID}&uid=${uid}&amt=${amt}`);
    const text = await res.text();
    showToast(text, true);
    fetchUsers();
  } catch(err){ showToast("‚ùå Failed to give coins"); }
}

function showToast(message, success=false){
  const toast = document.getElementById("toast");
  toast.innerText = message;
  toast.style.backgroundColor = success ? "#00d4a9" : "#ff4d4d";
  toast.className = "show";
  setTimeout(()=>{ toast.className = toast.className.replace("show",""); }, 3500);
}

// Initial load
fetchUsers();
fetchLeaderboard();
fetchBattles();

// Refresh every 10 seconds
setInterval(() => {
  fetchUsers();
  fetchLeaderboard();
  fetchBattles();
}, 10000);
</script>
</body>
</html>
